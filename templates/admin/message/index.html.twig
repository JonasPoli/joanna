{% extends ('ROLE_DEV' in app.user.roles) ? 'admin/layout.html.twig' : 'editor/layout.html.twig' %}

{% block title %}Mensagens{% endblock %}

{% block admin_content %}
    {{ block('main_content') }}
{% endblock %}

{% block editor_content %}
    {{ block('main_content') }}
{% endblock %}

{% block main_content %}
<div class="card bg-base-100 shadow-xl border border-base-200">
    <div class="card-body">
        <div class="flex justify-between items-center mb-6">
            <h2 class="card-title text-2xl font-bold">Gerenciamento de Mensagens</h2>
            <div class="join">
                <a href="{{ path('app_admin_message_index', {'status': 'unresolved'}) }}" class="join-item btn btn-sm {{ current_status == 'unresolved' ? 'btn-primary text-white' : 'btn-ghost' }}">Pendentes</a>
                <a href="{{ path('app_admin_message_index', {'status': 'resolved'}) }}" class="join-item btn btn-sm {{ current_status == 'resolved' ? 'btn-primary text-white' : 'btn-ghost' }}">Resolvidas</a>
                <a href="{{ path('app_admin_message_index', {'status': 'all'}) }}" class="join-item btn btn-sm {{ current_status == 'all' ? 'btn-primary text-white' : 'btn-ghost' }}">Todas</a>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="table w-full">
                <thead>
                    <tr>
                        <th>Participantes</th>
                        <th>Contexto (Referência)</th>
                        <th>Última Mensagem</th>
                        <th>Data</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for message in messages %}
                        {% set other_user = (message.sender == app.user) ? message.recipient : message.sender %}
                        <tr class="hover">
                            <td>
                                {% if is_admin|default(false) %}
                                    {# Admin: Mostra os dois participantes #}
                                    <div class="flex items-center -space-x-2">
                                        <div class="avatar placeholder">
                                            <div class="bg-primary text-primary-content rounded-full w-10">
                                                {% if message.sender.imageProfile %}
                                                    <img src="{{ message.sender.imageProfile }}" alt="{{ message.sender.name }}" class="rounded-full" />
                                                {% else %}
                                                    <span class="text-xs">{{ message.sender.name|slice(0,2)|upper }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="avatar placeholder">
                                            <div class="bg-secondary text-secondary-content rounded-full w-10 ring-2 ring-base-100">
                                                {% if message.recipient.imageProfile %}
                                                    <img src="{{ message.recipient.imageProfile }}" alt="{{ message.recipient.name }}" class="rounded-full" />
                                                {% else %}
                                                    <span class="text-xs">{{ message.recipient.name|slice(0,2)|upper }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-xs opacity-60 mt-1">{{ message.sender.name }} → {{ message.recipient.name }}</div>
                                {% else %}
                                    {# Usuário normal: Mostra só a outra pessoa #}
                                    <div class="flex items-center gap-3">
                                        <div class="avatar placeholder">
                                            <div class="bg-neutral text-neutral-content rounded-full w-10">
                                                {% if other_user.imageProfile %}
                                                    <img src="{{ other_user.imageProfile }}" alt="{{ other_user.name }}" class="rounded-full" />
                                                {% else %}
                                                    <span class="text-xs">{{ other_user.name|slice(0,2)|upper }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <span class="font-medium">{{ other_user.name }}</span>
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="font-bold">#{{ message.reference.id }}</div>
                                <div class="text-xs opacity-50">{{ message.reference.bibleBook.name }} {{ message.reference.bibleChapter }}</div>
                            </td>
                            <td>
                                <div class="max-w-xs truncate">
                                    <span class="font-medium">{{ message.sender == app.user ? 'Você: ' : message.sender.name ~ ': ' }}</span>
                                    {{ message.content }}
                                </div>
                            </td>
                            {% set isUnread = (message.status == 'unread' and message.recipient == app.user) %}
                            <td class="{{ isUnread ? 'text-green-600 font-medium' : '' }}">{{ message.createdAt|date('d/m/Y H:i') }}</td>
                            <td>
                                <div class="flex items-center gap-2">
                                    {% if isUnread %}
                                        <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                                        <span class="text-green-600 font-medium">Não lida</span>
                                    {% elseif message.status == 'read' %}
                                        <span class="w-3 h-3 bg-gray-300 rounded-full"></span>
                                        <span class="opacity-60">Lida</span>
                                    {% elseif message.status == 'resolved' %}
                                        <span class="w-3 h-3 bg-blue-400 rounded-full"></span>
                                        <span class="text-blue-600">Resolvida</span>
                                    {% else %}
                                        <span class="opacity-60">{{ message.status }}</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <a href="{{ path('app_admin_message_chat', {'id': message.reference.id}) }}" class="btn btn-ghost btn-xs">Abrir Chat</a>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-8 opacity-50 italic">Nenhuma conversa encontrada.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
